name: CI - Build & Validate

on:
  push:
    branches:
      - main
      - develop
      - "feature/**"
  pull_request:
    branches:
      - main
      - develop

jobs:
  build:
    name: Build ESP32-C3 Firmware
    runs-on: ubuntu-latest

    container:
      image: espressif/idf:v5.5.2

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build project
        run: |
          . $IDF_PATH/export.sh
          idf.py build

      - name: Generate build artifacts summary
        if: always()
        run: |
          echo "## Build Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "build/firmware.bin" ]; then
            ls -lh build/*.bin >> $GITHUB_STEP_SUMMARY
            echo "✓ Build successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "✗ Build failed - no binary found" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-artifacts
          path: |
            build/firmware.bin
            build/bootloader.bin
            build/partition_table/partition-table.bin
            build/flasher_args.json
          retention-days: 30
